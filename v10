<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ§ç„¡äººæ©Ÿå­¸ç§‘æ¸¬é©—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        button, [type='button'] {
            background-color: transparent;
            padding: 0;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* ç¾åŒ– checkbox */
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid currentColor;
            border-radius: 0.15em;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #3B82F6; /* tailwind blue-500 */
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* æ‰‹é¢¨ç´æ¨£å¼ */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::after {
            content: '+';
            float: right;
            font-size: 1.5em;
            font-weight: bold;
            line-height: 1;
            margin-top: -4px;
        }
        details[open] > summary::after {
            content: 'âˆ’';
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-200">

    <div class="min-h-screen flex items-center justify-center p-2 sm:p-4 relative">
        <div id="app-container" class="w-full max-w-3xl mx-auto">

            <!-- Loading Page -->
            <div id="loading-page" class="page active text-center">
                <div class="loader mx-auto"></div>
                <p id="loading-status" class="mt-4 text-slate-600">æ­£åœ¨è¼‰å…¥é¡Œåº«...</p>
            </div>

            <!-- Home Page -->
            <div id="home-page" class="page">
                <div class="w-full max-w-2xl mx-auto">
                    <div class="bg-white/70 backdrop-blur-sm p-8 md:p-12 rounded-2xl shadow-xl text-center">
                        <div class="flex justify-center items-center gap-4 mb-8">
                            <!-- Paper Plane Logo -->
                            <svg class="w-20 h-20 text-slate-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                            </svg>
                            <!-- Gemini Logo -->
                            <svg class="w-12 h-12 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L14.1213 9.87868L22 12L14.1213 14.1213L12 22L9.87868 14.1213L2 12L9.87868 9.87868L12 2Z" fill="currentColor"/>
                            </svg>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-10">é™æ§ç„¡äººæ©Ÿå­¸ç§‘æ¸¬é©—</h1>
                        <div class="space-y-5">
                            <button id="start-practice-btn" class="w-full max-w-xs mx-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                                åˆ†ç« å­¸ç¿’
                            </button>
                            <button id="start-exam-btn" class="w-full max-w-xs mx-auto bg-slate-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-slate-900 transition-all duration-300 transform hover:scale-105">
                                æ­£å¼æ¨¡æ“¬è€ƒ
                            </button>
                             <button id="filter-bank-btn" class="w-full max-w-xs mx-auto bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105">
                                è‡ªè¨‚é¡Œåº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic Select Page -->
            <div id="topic-select-page" class="page">
                <!-- Content generated by JS -->
            </div>

            <!-- Quiz Page -->
            <div id="quiz-page" class="page">
                <!-- Content generated by JS -->
            </div>

            <!-- Results Page -->
            <div id="results-page" class="page">
                <!-- Content generated by JS -->
            </div>
            
            <!-- Filter Page -->
            <div id="filter-page" class="page">
                 <!-- Content generated by JS -->
            </div>

        </div>
        
        <footer id="footer" class="absolute bottom-4 right-4 text-xs text-slate-400 text-right hidden">
             <p>é¡Œåº«ç‰ˆæœ¬: 114.05.28</p>
             <p>é™³å°é§¿ kelvinego@gmail.com</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800 mb-4"></h3>
            <div id="modal-body" class="text-slate-600 mb-6"></div>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition-colors">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>
    
    <input type="file" id="import-file-input" class="hidden" accept=".json">


    <script>
        // --- é¡Œåº«æ•¸æ“š ---
        let questionBank = [];

        // ==================================================================
        // == é¡Œåº« JSON æª”æ¡ˆç¶²å€ ==
        // ==================================================================
        const questionBankUrls = [
            "https://raw.githubusercontent.com/kelvinego/uav_exam/main/CHAPTER_1.json", // ç¬¬ä¸€ç« é¡Œåº«ç¶²å€
            "https://raw.githubusercontent.com/kelvinego/uav_exam/main/CHAPTER_2.json", // ç¬¬äºŒç« é¡Œåº«ç¶²å€
            "https://raw.githubusercontent.com/kelvinego/uav_exam/main/CHAPTER_3.json", // ç¬¬ä¸‰ç« é¡Œåº«ç¶²å€
            "https://raw.githubusercontent.com/kelvinego/uav_exam/main/CHAPTER_4.json"  // ç¬¬å››ç« é¡Œåº«ç¶²å€
        ];
        // ==================================================================

        const practiceTopics = [
            { name: "ç¬¬ä¸€ç«  æ°‘ç”¨èˆªç©ºæ³•åŠç›¸é—œæ³•è¦", categories: ["æ°‘ç”¨èˆªç©ºæ³•åŠç›¸é—œæ³•è¦"] },
            { name: "ç¬¬äºŒç«  åŸºç¤é£›è¡ŒåŸç†", categories: ["åŸºç¤é£›è¡ŒåŸç†"] },
            { name: "ç¬¬ä¸‰ç«  æ°£è±¡", categories: ["æ°£è±¡"] },
            { name: "ç¬¬å››ç«  ç·Šæ€¥è™•ç½®èˆ‡é£›è¡Œæ±ºç­–", categories: ["ç·Šæ€¥è™•ç½®èˆ‡é£›è¡Œæ±ºç­–"] }
        ];

        // --- App State ---
        let state = {
            currentMode: 'loading',
            currentTopic: null,
            questions: [],
            answers: {},
            isSubmitted: false,
            currentPage: 1,
            questionsPerPage: 10,
            examTimer: null,
            timeLeft: 0,
            currentExamQuestionIndex: 0,
            selectedQuestionIds: new Set(),
            examDistribution: {},
        };

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const footer = document.getElementById('footer');
        const importFileInput = document.getElementById('import-file-input');
        const loadingStatus = document.getElementById('loading-status');

        // --- Modal ---
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let confirmCallback = null;

        // --- Utility Functions ---
        const showPage = (pageId) => {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            footer.style.display = pageId === 'home-page' ? 'block' : 'none';
        };
        
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };
        
        const showModal = (title, body, onConfirm) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = body;
            confirmCallback = onConfirm;
            modal.classList.remove('hidden');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
            confirmCallback = null;
        };

        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        const getActiveQuestionBank = () => {
            if (state.selectedQuestionIds.size === 0) return [];
            return questionBank.filter(q => state.selectedQuestionIds.has(q.id));
        };

        // --- Rendering Functions ---

        const renderTopicSelect = () => {
            const container = document.getElementById('topic-select-page');
            const activeBank = getActiveQuestionBank();
            
            let topicsHtml = '';
            practiceTopics.forEach(topic => {
                const questionCount = activeBank.filter(q => topic.categories.includes(q.category)).length;
                if (questionCount > 0) {
                    topicsHtml += `
                        <button data-topic-name="${topic.name}" class="topic-btn w-full p-4 md:p-6 bg-white rounded-lg shadow-md hover:shadow-xl hover:bg-blue-50 transition-all duration-300 text-left flex justify-between items-center">
                            <h3 class="font-bold text-lg md:text-xl text-slate-800">${topic.name}</h3>
                            <div class="text-right">
                                <span class="text-lg font-semibold text-blue-600">${questionCount}</span>
                                <span class="text-sm text-slate-500 ml-1">é¡Œ</span>
                            </div>
                        </button>
                    `;
                }
            });

            container.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-800">é¸æ“‡å­¸ç¿’ä¸»é¡Œ</h2>
                    <button class="back-to-home text-slate-600 hover:text-slate-900">è¿”å›</button>
                </div>
                <div class="space-y-4">${topicsHtml}</div>
            `;
            
            container.querySelectorAll('.topic-btn').forEach(btn => {
                btn.onclick = () => {
                    const topic = practiceTopics.find(t => t.name === btn.dataset.topicName);
                    startPractice(topic);
                };
            });
            container.querySelector('.back-to-home').onclick = goHome;
            showPage('topic-select-page');
        };
        
        const renderQuizPage = () => {
             const quizPage = document.getElementById('quiz-page');
             if (state.currentMode === 'practice') {
                 renderPracticeMode(quizPage);
             } else if (state.currentMode === 'exam') {
                 renderExamMode(quizPage);
             }
        };

        const updatePracticeProgressBars = () => {
            const container = document.getElementById('quiz-page');
            if (!container || state.currentMode !== 'practice') return;

            const isRetestMode = state.currentTopic.name.includes('å†ç·´');
            const isMobile = window.innerWidth < 640;

            const chapterProgress = container.querySelector('#chapter-progress');
            if (chapterProgress) {
                if (isRetestMode) {
                    const totalRetestQuestions = state.questions.length;
                    const answeredRetestQuestions = Object.keys(state.answers).length;
                    chapterProgress.querySelector('span:first-child').textContent = 'éŒ¯é¡Œç·´ç¿’é€²åº¦';
                    chapterProgress.querySelector('span:last-child').textContent = `${answeredRetestQuestions} / ${totalRetestQuestions}`;
                    chapterProgress.querySelector('.progress-fill').style.width = `${(totalRetestQuestions > 0 ? (answeredRetestQuestions / totalRetestQuestions) * 100 : 0)}%`;
                } else {
                    const totalSelectedInChapter = state.questions.length;
                    const answeredInChapter = Object.keys(state.answers).length;
                    
                    chapterProgress.querySelector('span:first-child').textContent = 'æœ¬ç« ç·´ç¿’é€²åº¦';
                    chapterProgress.querySelector('span:last-child').textContent = `${answeredInChapter} / ${totalSelectedInChapter}`;
                    chapterProgress.querySelector('.progress-fill').style.width = `${(totalSelectedInChapter > 0 ? (answeredInChapter / totalSelectedInChapter) * 100 : 0)}%`;
                }
            }

            const pageProgress = container.querySelector('#page-progress');
            if (pageProgress) pageProgress.style.display = isMobile ? 'none' : 'block';
            
            const currentPageProgress = container.querySelector('#current-page-progress');
            if (currentPageProgress) currentPageProgress.style.display = isMobile ? 'none' : 'block';

            if (pageProgress && !isMobile) {
                const totalPages = Math.ceil(state.questions.length / state.questionsPerPage);
                pageProgress.querySelector('span:last-child').textContent = `${state.currentPage} / ${totalPages}`;
                pageProgress.querySelector('.progress-fill').style.width = `${(totalPages > 0 ? (state.currentPage / totalPages) * 100 : 0)}%`;
            }

            if (currentPageProgress && !isMobile) {
                const startIndex = (state.currentPage - 1) * state.questionsPerPage;
                const questionsOnPage = state.questions.slice(startIndex, startIndex + state.questionsPerPage);
                const answeredOnPageCount = questionsOnPage.filter(q => state.answers[q.id]).length;
                currentPageProgress.querySelector('span:last-child').textContent = `${answeredOnPageCount} / ${questionsOnPage.length}`;
                currentPageProgress.querySelector('.progress-fill').style.width = `${(questionsOnPage.length > 0 ? (answeredOnPageCount / questionsOnPage.length) * 100 : 0)}%`;
            }
        };

        const renderPracticeMode = (container) => {
            const totalPages = Math.ceil(state.questions.length / state.questionsPerPage);
            
            container.innerHTML = `
                <!-- Header -->
                <div class="sticky top-0 bg-slate-100/90 backdrop-blur-sm py-4 z-20 mb-8 px-2 sm:px-4 -mx-2 sm:-mx-4">
                    <div class="max-w-3xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg md:text-2xl font-bold text-slate-800">${state.currentTopic.name}</h2>
                            <button class="back-btn text-blue-600 hover:text-blue-800 font-semibold flex-shrink-0 ml-2">
                                ${state.currentTopic.name.includes('å†') ? 'è¿”å›ä¸»é¸å–®' : 'è¿”å›åˆ—è¡¨'}
                            </button>
                        </div>
                        <div id="practice-controls" class="space-y-2">
                            <div id="chapter-progress">
                                <div class="flex justify-between text-xs text-slate-600 mb-1"><span>æœ¬ç« ç·´ç¿’é€²åº¦</span><span>0 / 0</span></div>
                                <div class="w-full bg-slate-200 rounded-full h-2"><div class="progress-fill bg-blue-600 h-2 rounded-full" style="width: 0%"></div></div>
                            </div>
                            <div id="page-progress">
                                <div class="flex justify-between text-xs text-slate-600 mb-1"><span>æœ¬æ¬¡ç·´ç¿’é æ•¸</span><span>0 / 0</span></div>
                                <div class="w-full bg-slate-200 rounded-full h-2"><div class="progress-fill bg-green-500 h-2 rounded-full" style="width: 0%"></div></div>
                            </div>
                            <div id="current-page-progress" class="mb-4">
                                <div class="flex justify-between text-xs text-slate-600 mb-1"><span>æœ¬é ä½œç­”é€²åº¦</span><span>0 / 0</span></div>
                                <div class="w-full bg-slate-200 rounded-full h-2"><div class="progress-fill bg-amber-500 h-2 rounded-full" style="width: 0%"></div></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 pt-2">
                                <button id="load-progress-btn" class="w-full bg-sky-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-sky-600 transition-colors text-sm">è¼‰å…¥é€²åº¦</button>
                                <button id="save-progress-btn" class="w-full bg-amber-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-amber-600 transition-colors text-sm">å„²å­˜é€²åº¦</button>
                                <button id="reset-practice-btn" class="w-full bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 transition-colors text-sm">é‡ç½®ç·´ç¿’</button>
                            </div>
                        </div>
                        <div id="feedback-message" class="mt-2 p-2 bg-green-100 text-green-800 text-center rounded-md hidden"></div>
                    </div>
                </div>
                <div id="question-list" class="space-y-8"></div>
                <div class="mt-8 flex justify-between items-center">
                    <button id="prev-page-btn" class="bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-400 transition-colors disabled:opacity-50">ä¸Šä¸€é </button>
                    <span>${state.currentPage} / ${totalPages}</span>
                    <button id="next-page-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">ä¸‹ä¸€é </button>
                </div>
            `;
            
            updatePracticeDisplay();
            
            // Add event listeners
            container.querySelector('.back-btn').onclick = state.currentTopic.name.includes('å†') ? goHome : goToTopicSelect;
            container.querySelector('#load-progress-btn').onclick = loadProgress;
            container.querySelector('#save-progress-btn').onclick = saveProgress;
            container.querySelector('#reset-practice-btn').onclick = () => {
                showModal('ç¢ºèªæ¸…é™¤', 'ç¢ºå®šè¦æ¸…é™¤æœ¬ç« ç¯€çš„æ‰€æœ‰ä½œç­”ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚', resetPractice);
            };
        };

        const updatePracticeDisplay = () => {
            const container = document.getElementById('quiz-page');
            const totalPages = Math.ceil(state.questions.length / state.questionsPerPage);
            const startIndex = (state.currentPage - 1) * state.questionsPerPage;
            const endIndex = startIndex + state.questionsPerPage;
            const questionsOnPage = state.questions.slice(startIndex, endIndex);

            const questionList = container.querySelector('#question-list');
            questionList.innerHTML = '';
            questionsOnPage.forEach((q, index) => {
                questionList.appendChild(createQuestionElement(q, startIndex + index + 1));
            });

            updatePracticeProgressBars();

            const prevBtn = container.querySelector('#prev-page-btn');
            const nextBtn = container.querySelector('#next-page-btn');
            
            prevBtn.disabled = state.currentPage === 1;
            prevBtn.onclick = () => {
                if(state.currentPage > 1) {
                    state.currentPage--;
                    updatePracticeDisplay();
                }
            };
            
            if (state.currentPage === totalPages) {
                nextBtn.textContent = 'äº¤å·ä¸¦è¨‚æ­£';
                nextBtn.className = 'bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 transition-colors';
                nextBtn.onclick = submitPractice;
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€é ';
                nextBtn.className = 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors';
                nextBtn.onclick = () => {
                    if(state.currentPage < totalPages) {
                        state.currentPage++;
                        updatePracticeDisplay();
                    }
                };
            }
        };

        const renderExamMode = (container) => {
            const currentQuestion = state.questions[state.currentExamQuestionIndex];
            
            const distributionText = Object.entries(state.examDistribution)
                .sort(([keyA], [keyB]) => {
                    const numA = parseInt(keyA.match(/\d+/)[0]);
                    const numB = parseInt(keyB.match(/\d+/)[0]);
                    return numA - numB;
                })
                .map(([key, value]) => `${key}: ${value}é¡Œ`)
                .join(', ');

            if (!currentQuestion) {
                container.innerHTML = `<p class="text-center text-slate-600">æ²’æœ‰å¯ç”¨çš„é¡Œç›®ã€‚è«‹å…ˆè‡³ã€Œè‡ªè¨‚é¡Œåº«ã€å‹¾é¸é¡Œç›®ã€‚</p>
                <div class="mt-4 text-center">
                    <button class="back-to-home bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">è¿”å›ä¸»é </button>
                </div>
                `;
                 container.querySelector('.back-to-home').onclick = goHome;
                return;
            };

            let optionsHtml = '';
            currentQuestion.options.forEach((option, index) => {
                const optionLabel = String.fromCharCode(65 + index);
                const isSelected = state.answers[currentQuestion.id] === option;
                const btnClass = isSelected ? 'bg-blue-500 text-white' : 'bg-white hover:bg-slate-100';
                optionsHtml += `
                    <button data-question-id="${currentQuestion.id}" data-option-value="${option}" class="exam-option-btn w-full text-left p-4 rounded-lg border transition-all duration-200 ${btnClass}">
                        (${optionLabel}) ${option}
                    </button>
                `;
            });

            container.innerHTML = `
                <div class="flex flex-wrap sm:flex-nowrap justify-between items-center mb-4 sticky top-0 bg-slate-100/80 backdrop-blur-sm py-3 z-10 px-2">
                    <div class="w-full sm:w-auto flex-shrink-0 flex flex-col sm:flex-row sm:items-center text-center sm:text-left">
                        <h2 class="text-2xl font-bold text-slate-700 mb-1 sm:mb-0 sm:mr-2">æ¨¡æ“¬è€ƒè©¦</h2>
                        <span class="text-xs text-slate-500">(${distributionText})</span>
                    </div>
                    <div id="timer" class="w-auto text-xl font-mono bg-slate-800 text-white px-3 py-1 rounded-md text-center my-2 sm:my-0 sm:mx-4">${formatTime(state.timeLeft)}</div>
                    <div class="w-full sm:w-auto flex justify-center sm:justify-end">
                         <button id="exam-back-btn" class="text-red-600 hover:text-red-800 font-semibold flex-shrink-0">å–æ¶ˆæ¸¬é©—</button>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${((state.currentExamQuestionIndex + 1) / state.questions.length) * 100}%"></div>
                    </div>
                    <p class="text-right text-sm text-slate-500 mt-1">${state.currentExamQuestionIndex + 1} / ${state.questions.length}</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <p class="text-lg font-semibold text-slate-800 mb-6">${state.currentExamQuestionIndex + 1}. ${currentQuestion.question}</p>
                    <div class="space-y-3">${optionsHtml}</div>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <button id="exam-prev-btn" class="bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-400 transition-colors disabled:opacity-50">ä¸Šä¸€é¡Œ</button>
                    <button id="exam-next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">ä¸‹ä¸€é¡Œ</button>
                </div>
            `;

            const prevBtn = container.querySelector('#exam-prev-btn');
            const nextBtn = container.querySelector('#exam-next-btn');

            container.querySelector('#exam-back-btn').onclick = () => {
                showModal('ç¢ºèªè¿”å›', 'æ‚¨ç¢ºå®šè¦å–æ¶ˆæœ¬æ¬¡æ¨¡æ“¬è€ƒå—ï¼Ÿæ‰€æœ‰ä½œç­”ç´€éŒ„å°‡ä¸æœƒè¢«å„²å­˜ã€‚', () => {
                    clearInterval(state.examTimer);
                    goHome();
                });
            };

            prevBtn.disabled = state.currentExamQuestionIndex === 0;
            prevBtn.onclick = () => {
                if (state.currentExamQuestionIndex > 0) {
                    state.currentExamQuestionIndex--;
                    renderExamMode(container);
                }
            };

            if (state.currentExamQuestionIndex === state.questions.length - 1) {
                nextBtn.textContent = "äº¤å·";
                nextBtn.className = "bg-green-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-green-700 transition-colors";
                nextBtn.onclick = () => showModal('ç¢ºèªäº¤å·', 'ç¢ºå®šè¦æäº¤æ‚¨çš„ç­”æ¡ˆå—ï¼Ÿ', submitExam);
            } else {
                nextBtn.textContent = "ä¸‹ä¸€é¡Œ";
                nextBtn.className = "bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors";
                nextBtn.onclick = () => {
                    state.currentExamQuestionIndex++;
                    renderExamMode(container);
                };
            }

            container.querySelectorAll('.exam-option-btn').forEach(btn => {
                btn.onclick = (e) => handleExamAnswerSelect(e.currentTarget);
            });
        };

        const createQuestionElement = (question, number) => {
            const div = document.createElement('div');
            div.className = "bg-white p-4 md:p-6 rounded-lg shadow-lg";
            div.id = `q-${question.id}`;

            let optionsHtml = '';
            question.options.forEach((option, index) => {
                const optionLabel = String.fromCharCode(65 + index);
                const isSelected = state.answers[question.id] === option;
                const btnClass = isSelected ? 'bg-blue-500 text-white border-blue-500' : 'bg-white hover:bg-slate-100 border-slate-300';
                optionsHtml += `
                    <button data-question-id="${question.id}" data-option-value="${option}" class="option-btn w-full text-left p-3 md:p-4 rounded-lg border transition-all duration-200 ${btnClass}">
                        (${optionLabel}) ${option}
                    </button>
                `;
            });

            div.innerHTML = `
                <p class="text-base md:text-lg font-semibold text-slate-800 mb-6">${number}. ${question.question}</p>
                <div class="space-y-3">${optionsHtml}</div>
            `;

            div.querySelectorAll('.option-btn').forEach(btn => {
                btn.onclick = (e) => handleAnswerSelect(e.currentTarget);
            });

            return div;
        };
        
        const renderResultsPage = (questions, answers, context) => {
            const resultsPage = document.getElementById('results-page');
            const score = questions.reduce((acc, q) => acc + (answers[q.id] === q.answer ? 1 : 0), 0);
            const finalScore = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
            const incorrectQuestions = questions.filter(q => answers[q.id] !== q.answer);
            
            let resultsHtml = '';
            questions.forEach((q, index) => {
                resultsHtml += createResultItemElement(q, answers[q.id], index + 1);
            });

            let actionButtonsHtml = '';
            if (context.isExam) {
                actionButtonsHtml += `<button id="restart-exam-btn" class="w-full max-w-sm bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-colors">é–‹å§‹æ–°æ¨¡æ“¬è€ƒ</button>`;
                if (incorrectQuestions.length > 0) {
                    actionButtonsHtml += `<button id="review-incorrect-btn" class="w-full max-w-sm bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-cyan-700 transition-colors">ç¯©é¸éŒ¯é¡Œ</button>`;
                }
            } else { // Practice Mode
                if (incorrectQuestions.length > 0) {
                    actionButtonsHtml += `<button id="review-incorrect-btn" class="w-full max-w-sm bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-colors">ç¯©é¸éŒ¯é¡Œ</button>`;
                }
            }

            if (incorrectQuestions.length > 0) {
                actionButtonsHtml += `<button id="retest-incorrect-btn" class="w-full max-w-sm bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-orange-600 transition-colors">éŒ¯é¡Œå†ç·´</button>`;
            }
            actionButtonsHtml += `<button class="back-to-home w-full max-w-sm bg-slate-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-slate-900 transition-colors">è¿”å›ä¸»é¸å–®</button>`;


            resultsPage.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4">æ¸¬é©—çµæœ</h2>
                    <div class="p-6 md:p-8 rounded-lg bg-slate-100 mb-8">
                        <p class="text-5xl font-bold text-slate-800 mb-2">
                            ${finalScore}<span class="text-3xl font-medium ml-1">åˆ†</span>
                        </p>
                        <p class="text-lg text-slate-600">(ç­”å° ${score} / ${questions.length} é¡Œ)</p>
                    </div>
                </div>
                <div class="text-left mb-8">
                    <h3 class="text-2xl font-bold text-slate-800 mb-4">ä½œç­”åˆ†æ</h3>
                    <div id="result-list" class="space-y-6">${resultsHtml}</div>
                </div>
                <div class="mt-8 flex flex-col items-center gap-4">
                    ${actionButtonsHtml}
                </div>
            `;

            // Add event listeners
            const restartExamBtn = resultsPage.querySelector('#restart-exam-btn');
            if (restartExamBtn) restartExamBtn.onclick = startExam;

            const reviewIncorrectBtn = resultsPage.querySelector('#review-incorrect-btn');
            if (reviewIncorrectBtn) reviewIncorrectBtn.onclick = (e) => toggleIncorrectView(e.currentTarget);
            
            const retestIncorrectBtn = resultsPage.querySelector('#retest-incorrect-btn');
            if(retestIncorrectBtn) retestIncorrectBtn.onclick = () => startRetest(incorrectQuestions);

            resultsPage.querySelectorAll('.back-to-home').forEach(btn => btn.onclick = goHome);
            resultsPage.querySelectorAll('.ai-tutor-btn').forEach(btn => {
                btn.onclick = (e) => getAiExplanation(e.currentTarget);
            });
            resultsPage.querySelectorAll('.ai-scenario-btn').forEach(btn => {
                btn.onclick = (e) => getAiScenario(e.currentTarget);
            });
            resultsPage.querySelectorAll('.ai-memory-tip-btn').forEach(btn => {
                btn.onclick = (e) => getAiMemoryTip(e.currentTarget);
            });

            showPage('results-page');
        };
        
        const createResultItemElement = (question, userAnswer, questionNumber) => {
            const isCorrect = userAnswer === question.answer;
            const chapterNumber = practiceTopics.findIndex(t => t.categories.includes(question.category)) + 1;

            let optionsHtml = '';
            question.options.forEach((option, i) => {
                const optionLabel = `(${String.fromCharCode(65 + i)})`;
                let style = "text-slate-600";
                let indicator = '';

                if (option === question.answer) {
                    style = "text-green-800 font-bold";
                    indicator = `<span class="text-green-500 mr-2">âœ”</span>`;
                }
                if (option === userAnswer && !isCorrect) {
                    style = "text-red-800";
                    indicator = `<span class="text-red-500 mr-2">âœ–</span>`;
                }
                optionsHtml += `<p class="text-sm ${style}">${indicator}${optionLabel} ${option}</p>`;
            });

            return `
                <div class="result-item ${isCorrect ? 'is-correct' : ''} p-4 rounded-lg shadow border-l-4 ${isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}">
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-semibold text-slate-800 pr-4">${questionNumber}. ${question.question}</p>
                        <span class="text-xs text-slate-400 whitespace-nowrap flex-shrink-0">
                            (é¡Œåº« ç¬¬${chapterNumber}ç«  ç¬¬${question.originalId}é¡Œ)
                        </span>
                    </div>
                    <div class="space-y-2 mt-4">${optionsHtml}</div>
                    ${question.explanation ? `
                    <div class="mt-4 pt-2 border-t border-slate-200">
                        <p class="text-sm text-slate-700 font-semibold">è§£æï¼š</p>
                        <p class="text-sm text-slate-600">${question.explanation}</p>
                    </div>` : ''}
                    <div class="mt-4 pt-2 border-t border-slate-200 flex flex-wrap gap-2">
                        ${!isCorrect ? `<button class="ai-tutor-btn text-sm bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity" data-question-id="${question.id}" data-user-answer="${userAnswer || ''}">âœ¨ AI è€å¸«è§£æƒ‘</button>` : ''}
                        <button class="ai-scenario-btn text-sm bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity" data-question-id="${question.id}">âœ¨ ç”¢ç”Ÿé£›èˆªæƒ…å¢ƒé¡Œ</button>
                        <button class="ai-memory-tip-btn text-sm bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity" data-question-id="${question.id}">ğŸ§  ç¡¬è¨˜å°æŠ€å·§</button>
                    </div>
                    <div id="ai-response-${question.id}" class="mt-2 p-3 bg-slate-100 rounded-lg text-sm text-slate-700 whitespace-pre-wrap hidden"></div>
                </div>
            `;
        };


        const renderFilterPage = () => {
            const container = document.getElementById('filter-page');
            let content = '';

            practiceTopics.forEach((topic, index) => {
                const questionsInCategory = questionBank.filter(q => topic.categories.includes(q.category));
                if (questionsInCategory.length > 0) {
                    const selectedInCategory = questionsInCategory.filter(q => state.selectedQuestionIds.has(q.id)).length;
                    content += `
                        <details class="bg-white rounded-lg shadow mb-2" ${index === 0 ? 'open' : ''}>
                            <summary class="p-4 font-bold text-slate-800 cursor-pointer flex justify-between items-center">
                                ${topic.name}
                                <span class="text-sm font-normal text-slate-500">(å·²é¸ ${selectedInCategory} / å…± ${questionsInCategory.length} é¡Œ)</span>
                            </summary>
                            <div class="p-4 border-t border-slate-200">
                    `;
                    questionsInCategory.forEach(q => {
                        const isChecked = state.selectedQuestionIds.has(q.id);
                        content += `
                            <label class="flex items-center space-x-3 p-2 rounded hover:bg-slate-100 cursor-pointer">
                                <input type="checkbox" class="custom-checkbox" data-id="${q.id}" ${isChecked ? 'checked' : ''}>
                                <span class="text-sm text-slate-700">${q.originalId}. ${q.question}</span>
                            </label>
                        `;
                    });
                    content += `</div></details>`;
                }
            });

            container.innerHTML = `
                <div class="sticky top-0 bg-slate-100/90 backdrop-blur-sm py-4 z-20 mb-4 px-2 sm:px-4 -mx-2 sm:-mx-4">
                    <div class="max-w-3xl mx-auto">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800">è‡ªè¨‚é¡Œåº«</h2>
                            <button class="back-to-home text-slate-600 hover:text-slate-900">è¿”å›</button>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
                            <button id="export-filter-btn" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700">åŒ¯å‡ºç¯©é¸</button>
                            <button id="import-filter-btn" class="bg-purple-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-purple-700">åŒ¯å…¥ç¯©é¸</button>
                            <button id="select-all-btn" class="bg-gray-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-600">å…¨é¸</button>
                            <button id="deselect-all-btn" class="bg-gray-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-600">å…¨ä¸é¸</button>
                        </div>
                         <div id="filter-feedback" class="mt-2 p-2 text-center rounded-md hidden"></div>
                    </div>
                </div>
                <div>
                    ${content}
                </div>
            `;
            
            // Add event listeners
            container.querySelector('.back-to-home').onclick = goHome;
            container.querySelector('#export-filter-btn').onclick = exportFilter;
            container.querySelector('#import-filter-btn').onclick = () => importFileInput.click();
            container.querySelector('#select-all-btn').onclick = selectAll;
            container.querySelector('#deselect-all-btn').onclick = deselectAll;
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = handleFilterChange;
            });

            showPage('filter-page');
        };

        // --- Event Handlers & Logic ---
        
        const startPractice = (topic) => {
            state.currentMode = 'practice';
            state.currentTopic = topic;
            const activeBank = getActiveQuestionBank();
            state.questions = activeBank.filter(q => topic.categories.includes(q.category));
            
            if (state.questions.length === 0) {
                alert(`ã€Œ${topic.name}ã€ä¸­æ²’æœ‰è¢«å‹¾é¸çš„é¡Œç›®ï¼Œè«‹å…ˆè‡³ã€Œè‡ªè¨‚é¡Œåº«ã€ä¸­é¸å–ã€‚`);
                return;
            }

            state.answers = {};
            state.isSubmitted = false;
            state.currentPage = 1;
            renderPracticeMode(document.getElementById('quiz-page'));
            showPage('quiz-page');
        };

        const startExam = () => {
            const activeBank = getActiveQuestionBank();
            if (activeBank.length === 0) {
                 alert(`æ²’æœ‰é¸æ“‡ä»»ä½•é¡Œç›®ï¼Œç„¡æ³•é€²è¡Œæ¨¡æ“¬è€ƒã€‚è«‹å…ˆè‡³ã€Œè‡ªè¨‚é¡Œåº«ã€å‹¾é¸é¡Œç›®ã€‚`);
                return;
            }

            state.currentMode = 'exam';
            state.answers = {};
            state.currentExamQuestionIndex = 0;
            const shuffled = shuffleArray([...activeBank]);
            
            state.questions = shuffled.slice(0, Math.min(40, shuffled.length));
            
            state.examDistribution = state.questions.reduce((acc, q) => {
                const topic = practiceTopics.find(t => t.categories.includes(q.category));
                const chapterName = topic ? `ç¬¬${practiceTopics.indexOf(topic) + 1}ç« ` : 'å…¶ä»–';
                acc[chapterName] = (acc[chapterName] || 0) + 1;
                return acc;
            }, {});

            state.timeLeft = 60 * 60;

            clearInterval(state.examTimer);
            state.examTimer = setInterval(updateTimer, 1000);
            
            renderExamMode(document.getElementById('quiz-page'));
            showPage('quiz-page');
        };

        const updateTimer = () => {
            state.timeLeft--;
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.textContent = formatTime(state.timeLeft);
            }
            if (state.timeLeft <= 0) {
                submitExam();
            }
        };
        
        const submitExam = () => {
            clearInterval(state.examTimer);
            renderResultsPage(state.questions, state.answers, { isExam: true });
        };

        const handleExamAnswerSelect = (button) => {
            const questionId = parseInt(button.dataset.questionId);
            const optionValue = button.dataset.optionValue;
            state.answers[questionId] = optionValue;
            renderExamMode(document.getElementById('quiz-page')); // Re-render to show selection
        };

        const startRetest = (incorrectQuestions) => {
            const retestTopic = { name: 'éŒ¯é¡Œå†ç·´' };
            state.currentMode = 'practice';
            state.currentTopic = retestTopic;
            state.questions = incorrectQuestions;
            state.answers = {};
            state.isSubmitted = false;
            state.currentPage = 1;
            renderPracticeMode(document.getElementById('quiz-page'));
            showPage('quiz-page');
        };
        
        const goHome = () => {
            showPage('home-page');
        };

        const goToTopicSelect = () => {
            renderTopicSelect();
        };

        const handleAnswerSelect = (button) => {
            const questionId = parseInt(button.dataset.questionId);
            const optionValue = button.dataset.optionValue;

            if (state.answers[questionId] === optionValue) {
                delete state.answers[questionId];
            } else {
                state.answers[questionId] = optionValue;
            }
            
            const questionContainer = document.getElementById(`q-${questionId}`);
            questionContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-white', 'hover:bg-slate-100', 'border-slate-300');
            });
            
            if (state.answers[questionId]) {
                 button.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                 button.classList.remove('bg-white', 'hover:bg-slate-100', 'border-slate-300');
            }

            updatePracticeProgressBars();
        };
        
        const submitPractice = () => {
            renderResultsPage(state.questions, state.answers, { isExam: false, topic: state.currentTopic });
        };
        
        const toggleIncorrectView = (button) => {
            const resultList = document.getElementById('result-list');
            const correctItems = resultList.querySelectorAll('.is-correct');
            const isHiding = button.textContent === 'ç¯©é¸éŒ¯é¡Œ';

            correctItems.forEach(item => {
                item.classList.toggle('hidden', isHiding);
            });

            button.textContent = isHiding ? 'é¡¯ç¤ºå…¨éƒ¨' : 'ç¯©é¸éŒ¯é¡Œ';
        };

        const showFeedbackMessage = (msg, isError = false) => {
            const feedbackEl = document.querySelector('#feedback-message, #filter-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = msg;
                feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                if(isError) {
                    feedbackEl.classList.add('bg-red-100', 'text-red-800');
                } else {
                    feedbackEl.classList.add('bg-green-100', 'text-green-800');
                }
                setTimeout(() => {
                    feedbackEl.classList.add('hidden');
                }, 3000);
            }
        };

        const saveProgress = () => {
            try {
                localStorage.setItem(`practice_${state.currentTopic.name}`, JSON.stringify(state.answers));
                showFeedbackMessage('é€²åº¦å·²å„²å­˜ï¼');
            } catch (e) {
                showFeedbackMessage('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
            }
        };

        const loadProgress = () => {
            try {
                const saved = localStorage.getItem(`practice_${state.currentTopic.name}`);
                if (saved) {
                    state.answers = JSON.parse(saved);
                    renderPracticeMode(document.getElementById('quiz-page'));
                    showFeedbackMessage('å·²æˆåŠŸè¼‰å…¥ä¸Šæ¬¡å„²å­˜çš„é€²åº¦ï¼');
                } else {
                    showFeedbackMessage('æ‰¾ä¸åˆ°æœ¬ç« ç¯€çš„å„²å­˜ç´€éŒ„ã€‚');
                }
            } catch (e) {
                showFeedbackMessage('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
            }
        };
        
        const resetPractice = () => {
            try {
                localStorage.removeItem(`practice_${state.currentTopic.name}`);
                state.answers = {};
                renderPracticeMode(document.getElementById('quiz-page'));
                showFeedbackMessage('æœ¬ç« ç¯€çš„ä½œç­”ç´€éŒ„å·²æ¸…é™¤ï¼');
            } catch (e) {
                showFeedbackMessage('æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
            }
            hideModal();
        };

        // --- Filter Page Logic ---
        const silentSaveFilter = () => {
            try {
                localStorage.setItem('droneQuizSelectedIds', JSON.stringify(Array.from(state.selectedQuestionIds)));
            } catch (e) {
                console.error("Auto-save failed!", e);
            }
        };

        const handleFilterChange = (event) => {
            const id = parseInt(event.target.dataset.id);
            if (event.target.checked) {
                state.selectedQuestionIds.add(id);
            } else {
                state.selectedQuestionIds.delete(id);
            }
            silentSaveFilter();
            // Update the count in the summary
            const summary = event.target.closest('details').querySelector('summary');
            const topicName = summary.textContent.trim().split('\n')[0];
            const topic = practiceTopics.find(t => t.name === topicName);
            const questionsInCategory = questionBank.filter(q => topic.categories.includes(q.category));
            const selectedInCategory = questionsInCategory.filter(q => state.selectedQuestionIds.has(q.id)).length;
            summary.querySelector('span').textContent = `(å·²é¸ ${selectedInCategory} / å…± ${questionsInCategory.length} é¡Œ)`;
        };

        const selectAll = () => {
            state.selectedQuestionIds = new Set(questionBank.map(q => q.id));
            renderFilterPage();
            silentSaveFilter();
        };

        const deselectAll = () => {
            state.selectedQuestionIds.clear();
            renderFilterPage();
            silentSaveFilter();
        };
        
        const loadFilter = () => {
            try {
                const saved = localStorage.getItem('droneQuizSelectedIds');
                if (saved) {
                    const ids = JSON.parse(saved);
                    state.selectedQuestionIds = new Set(ids);
                } else {
                     state.selectedQuestionIds = new Set(questionBank.map(q => q.id));
                }
            } catch (e) {
                console.error("Failed to load filter from localStorage", e);
                state.selectedQuestionIds = new Set(questionBank.map(q => q.id));
            }
        };

        const exportFilter = () => {
            const ids = Array.from(state.selectedQuestionIds);
            const blob = new Blob([JSON.stringify(ids, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
            a.download = `${timestamp}-${ids.length}é¡Œ.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const importFilter = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const ids = JSON.parse(e.target.result);
                    if (Array.isArray(ids) && ids.every(id => typeof id === 'number')) {
                        state.selectedQuestionIds = new Set(ids);
                        renderFilterPage();
                        silentSaveFilter();
                        showFeedbackMessage(`æˆåŠŸåŒ¯å…¥ ${ids.length} é¡Œç¯©é¸è¨­å®šï¼`);
                    } else {
                        throw new Error('Invalid file format');
                    }
                } catch (err) {
                    showFeedbackMessage('æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ç„¡æ•ˆï¼', true);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        };

        // --- Gemini API Functions ---
        const callGeminiAPI = async (prompt) => {
            if (window.location.protocol === 'file:') {
                return "API_FETCH_FAILED";
            }
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        }
                    }
                } catch (error) {
                    console.error("Gemini API call failed on attempt", i + 1, error);
                    if (i === retries - 1) return "API_FETCH_FAILED";
                }
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            return null;
        };

        const handleAiResponse = (response, container) => {
            if (response === "API_FETCH_FAILED") {
                container.innerHTML = 'AI åŠŸèƒ½ä¼¼ä¹ç„¡æ³•é€£ç·šã€‚å¦‚æœæ‚¨æ˜¯ç›´æ¥é–‹å•Ÿ HTML æª”æ¡ˆï¼Œé€™æ˜¯æ­£å¸¸ç¾è±¡ã€‚è«‹å°‡æ­¤æª”æ¡ˆéƒ¨ç½²åˆ°ç¶²è·¯ç©ºé–“ï¼ˆä¾‹å¦‚ Netlify Dropï¼‰å³å¯æ­£å¸¸ä½¿ç”¨ AI åŠŸèƒ½ã€‚';
            } else if (response) {
                container.innerHTML = response;
            } else {
                container.innerHTML = 'æŠ±æ­‰ï¼ŒAI åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            }
        };

        const getAiExplanation = async (button) => {
            const questionId = parseInt(button.dataset.questionId);
            const userAnswer = button.dataset.userAnswer;
            const question = questionBank.find(q => q.id === questionId);
            const responseContainer = document.getElementById(`ai-response-${questionId}`);

            if (!question || !responseContainer) return;

            responseContainer.innerHTML = `<div class="loader mx-auto"></div><p class="text-center text-sm text-slate-500 mt-2">AI è€å¸«æ€è€ƒä¸­...</p>`;
            responseContainer.classList.remove('hidden');

            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç„¡äººæ©Ÿé£›è¡Œæ•™å®˜ã€‚æœ‰åå­¸å“¡æ­£åœ¨æº–å‚™å­¸ç§‘è€ƒè©¦ï¼Œä»–é‡åˆ°äº†ä»¥ä¸‹å•é¡Œï¼š
        
            é¡Œç›®ï¼š${question.question}
            ä»–çš„ç­”æ¡ˆï¼š${userAnswer || 'æœªä½œç­”'}
            æ­£ç¢ºç­”æ¡ˆï¼š${question.answer}

            è«‹ç”¨ç¹é«”ä¸­æ–‡ã€å‹å–„ä¸”é¼“å‹µçš„èªæ°£ï¼Œç°¡å–®æ‰¼è¦åœ°è§£é‡‹ï¼š
            1. ç‚ºä»€éº¼ä»–çš„ç­”æ¡ˆæ˜¯éŒ¯çš„ï¼ˆå¦‚æœä»–æœ‰ä½œç­”ï¼‰ã€‚
            2. ç‚ºä»€éº¼æ­£ç¢ºç­”æ¡ˆæ˜¯å°çš„ã€‚
            3. å¯ä»¥çš„è©±ï¼Œèˆ‰ä¸€å€‹ç°¡å–®çš„ç”Ÿæ´»ä¾‹å­æˆ–æ¯”å–»ä¾†å¹«åŠ©ä»–ç†è§£é€™å€‹è§€å¿µã€‚`;

            const explanation = await callGeminiAPI(prompt);
            handleAiResponse(explanation, responseContainer);
        };

        const getAiScenario = async (button) => {
            const questionId = parseInt(button.dataset.questionId);
            const question = questionBank.find(q => q.id === questionId);
            const responseContainer = document.getElementById(`ai-response-${questionId}`);

            if (!question || !responseContainer) return;
            
            responseContainer.innerHTML = `<div class="loader mx-auto"></div><p class="text-center text-sm text-slate-500 mt-2">AI æ­£åœ¨ç”¢ç”Ÿæƒ…å¢ƒé¡Œ...</p>`;
            responseContainer.classList.remove('hidden');

            const prompt = `ä½ æ˜¯ä¸€ä½é™æ§ç„¡äººæ©Ÿçš„è¡“ç§‘æ¸¬é©—è€ƒå®˜ã€‚è«‹æ ¹æ“šä»¥ä¸‹çš„å­¸ç§‘çŸ¥è­˜é»ï¼Œè¨­è¨ˆä¸€å€‹ç°¡çŸ­çš„ã€å¯¦éš›çš„é£›è¡Œæ“ä½œæƒ…å¢ƒé¡Œï¼ˆç´„100-150å­—ï¼‰ã€‚é€™å€‹æƒ…å¢ƒé¡Œæ‡‰è©²è¦èƒ½æ¸¬é©—å‡ºè€ƒç”Ÿæ˜¯å¦çœŸæ­£ç†è§£ä¸¦èƒ½æ‡‰ç”¨é€™å€‹çŸ¥è­˜é»ã€‚æœ€å¾Œè«‹é™„ä¸Šæƒ…å¢ƒé¡Œçš„åƒè€ƒç­”æ¡ˆèˆ‡ç°¡çŸ­è§£æã€‚

            çŸ¥è­˜é»ï¼š
            é¡Œç›®ï¼š${question.question}
            æ­£ç¢ºç­”æ¡ˆï¼š${question.answer}

            è«‹ç”¨ç¹é«”ä¸­æ–‡è¼¸å‡ºã€‚`;

            const scenario = await callGeminiAPI(prompt);
            handleAiResponse(scenario, responseContainer);
        };

        const getAiMemoryTip = async (button) => {
            const questionId = parseInt(button.dataset.questionId);
            const question = questionBank.find(q => q.id === questionId);
            const responseContainer = document.getElementById(`ai-response-${questionId}`);

            if (!question || !responseContainer) return;
            
            responseContainer.innerHTML = `<div class="loader mx-auto"></div><p class="text-center text-sm text-slate-500 mt-2">AI æ­£åœ¨æä¾›è¨˜æ†¶æŠ€å·§...</p>`;
            responseContainer.classList.remove('hidden');

            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆé–€å¹«åŠ©è€ƒç”Ÿè¨˜æ†¶çš„å°ˆå®¶ã€‚è«‹é‡å°ä»¥ä¸‹é€™é“é™æ§ç„¡äººæ©Ÿå­¸ç§‘æ¸¬é©—é¡Œç›®ï¼Œæä¾›ä¸€å€‹ã€Œç°¡å–®ã€æ‰¼è¦ã€èƒ½åˆ‡ä¸­ç­”æ¡ˆã€çš„è¨˜æ†¶å£è¨£æˆ–å°æŠ€å·§ï¼Œå¹«åŠ©è€ƒç”Ÿç¡¬è¨˜ä½æ­£ç¢ºç­”æ¡ˆã€‚

            é¡Œç›®ï¼š${question.question}
            æ­£ç¢ºç­”æ¡ˆï¼š${question.answer}

            ä½ çš„å›ç­”æ‡‰è©²éå¸¸ç°¡æ½”ï¼Œç›´æ¥çµ¦å‡ºè¨˜æ†¶æ–¹æ³•ï¼Œä¸éœ€è¦éå¤šè§£é‡‹ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;

            const tip = await callGeminiAPI(prompt);
            handleAiResponse(tip, responseContainer);
        };

        const loadAllQuestionBanks = async () => {
            try {
                const responses = await Promise.all(questionBankUrls.map(url => {
                    if (url.includes("URL_TO_CHAPTER")) {
                        return Promise.resolve(null);
                    }
                    return fetch(url).catch(e => {
                        console.error(`Failed to fetch ${url}`, e);
                        return { ok: false, statusText: e.message, url };
                    });
                }));
                
                const jsonPromises = responses.map((res, index) => {
                    if (res === null) return Promise.resolve([]);
                    if (!res.ok) {
                        throw new Error(`ç„¡æ³•è¼‰å…¥ç« ç¯€ ${index + 1} é¡Œåº« (URL: ${res.url})`);
                    }
                    return res.json();
                });
                const allChapters = await Promise.all(jsonPromises);
                questionBank = [].concat(...allChapters);
                
                if (questionBank.length === 0) {
                     throw new Error("æ‰€æœ‰é¡Œåº«ç¶²å€å‡ç„¡æ³•è¼‰å…¥æˆ–æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²å€è¨­å®šã€‚");
                }

                loadFilter();
                showPage('home-page');

            } catch (error) {
                loadingStatus.textContent = `é¡Œåº«è¼‰å…¥å¤±æ•—: ${error.message}`;
                loadingStatus.classList.add('text-red-600');
            }
        };


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAllQuestionBanks();

            document.getElementById('start-practice-btn').onclick = goToTopicSelect;
            document.getElementById('start-exam-btn').onclick = startExam;
            document.getElementById('filter-bank-btn').onclick = renderFilterPage;
            
            importFileInput.onchange = importFilter;
            
            modalCancelBtn.onclick = hideModal;
            modalConfirmBtn.onclick = () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideModal();
            };
        });

    </script>
</body>
</html>
